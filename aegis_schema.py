"""\naegis_schema.py â€” Aegis Data Schema & Normalization Module\nVersion: 8.0 (MASTER: 15 Schemas - Full SERP Alignment + All Original Enhancements)\n"""\n\nimport pandas as pd\nimport numpy as np\nimport re\nimport hashlib\nfrom datetime import datetime\nfrom typing import Dict, Any, Optional\n\n# =============================================================================\n# NORMALIZATION UTILS\n# =============================================================================\n\nNULL_MARKERS = ['NAN', 'nan', 'NaN', '--', '', ' ', 'N/A', 'n/a', '#N/A', 'null', 'NULL', 'None']\n\ndef is_null(val: Any) -> bool:\n    if pd.isna(val): return True\n    if isinstance(val, str) and val.strip() in NULL_MARKERS: return True\n    return False\n\ndef normalize_int(val: Any) -> int:\n    if is_null(val): return 0\n    if isinstance(val, str):\n        val = val.replace(',', '').split('.')[0].strip()\n        if val == '': return 0\n    try: return int(float(val))\n    except: return 0\n\ndef normalize_float(val: Any) -> Optional[float]:\n    if is_null(val): return None\n    if isinstance(val, str):\n        val = val.replace(',', '').replace('$', '').replace('%', '').strip()\n        if val == '': return None\n    try: return float(val)\n    except: return None\n\ndef normalize_cost(val: Any) -> float:\n    if is_null(val): return 0.0\n    if isinstance(val, str):\n        val = re.sub(r'[^0-9.\\-]', '', val)\n        if val == '' or val == '.': return 0.0\n    try: return float(val)\n    except: return 0.0\n\ndef normalize_string(val: Any) -> Optional[str]:\n    if is_null(val): return None\n    return str(val).strip()\n\ndef normalize_date(val: Any) -> Optional[str]:\n    if is_null(val): return None\n    if isinstance(val, str):\n        val = val.strip()\n        if re.match(r'^\\d{4}-\\d{2}-\\d{2}$', val): return val\n        for fmt in ['%Y-%m-%d', '%m/%d/%Y', '%d/%m/%Y', '%Y/%m/%d', '%m-%d-%Y']:\n            try: return datetime.strptime(val, fmt).strftime('%Y-%m-%d')\n            except ValueError: continue\n    try: return pd.to_datetime(val).strftime('%Y-%m-%d')\n    except: return None\n\ndef normalize_zip(val: Any) -> Optional[str]:\n    if is_null(val): return None\n    val = str(val).strip().strip('\"').strip(\"'\")\n    val = re.sub(r'[^0-9]', '', val)\n    if val == '': return None\n    if len(val) <= 5: return val.zfill(5)\n    return val\n\n# =============================================================================\n# SCHEMA DEFINITIONS (15 SCHEMAS TOTAL)\n# =============================================================================\n\nSCHEMAS: Dict[str, Dict[str, Any]] = {\n    # --- 1. INVENTORY (ENHANCED) ---\n    'inventory_vehicle': {\n        'name': 'inventory_vehicle',\n        'primary_key': ['vin'],\n        'columns': [\n            {'name': 'year', 'type': 'int', 'required': True},\n            {'name': 'make', 'type': 'string', 'required': False},\n            {'name': 'model', 'type': 'string', 'required': True},\n            {'name': 'trim', 'type': 'string', 'required': False},\n            {'name': 'vin', 'type': 'string', 'required': True},\n            {'name': 'stock_number', 'type': 'string', 'required': False},\n            {'name': 'price', 'type': 'float', 'required': False},\n            {'name': 'msrp', 'type': 'float', 'required': False},\n            {'name': 'savings', 'type': 'float', 'required': False},\n            {'name': 'mileage', 'type': 'int', 'required': False},\n            {'name': 'exterior_color', 'type': 'string', 'required': False},\n            {'name': 'interior_color', 'type': 'string', 'required': False},\n            {'name': 'transmission', 'type': 'string', 'required': False},\n            {'name': 'drivetrain', 'type': 'string', 'required': False},\n            {'name': 'engine', 'type': 'string', 'required': False},\n            {'name': 'status', 'type': 'string', 'required': False},\n            {'name': 'dealer', 'type': 'string', 'required': False},\n            {'name': 'url', 'type': 'string', 'required': False},\n            {'name': 'image_url', 'type': 'string', 'required': False},\n            {'name': '_make_model_combined', 'type': 'string', 'required': False},\n        ],\n        'column_map': {\n            'VIN': 'vin', 'Stock Number': 'stock_number', 'Year': 'year',\n            'Make': 'make', 'Model': 'model', 'Trim': 'trim',\n            'Price': 'price', 'MSRP': 'msrp', 'Savings': 'savings',\n            'Mileage': 'mileage', 'Exterior Color': 'exterior_color',\n            'Interior Color': 'interior_color',\n            'Vehicle Name': '_make_model_combined', 'Vehicle name': '_make_model_combined',\n            'Final Price (USD)': 'price', 'Internet Price': 'price', 'Selling Price': 'price',\n            'MSRP (USD)': 'msrp', 'Retail Price': 'msrp',\n            'Vehicle URL': 'url', 'Vehicle Url': 'url', 'Vehicle Image': 'image_url',\n            'vin-row': 'vin', 'stock-row': 'stock_number', 'title-top': 'year',\n            'title-bottom': '_make_model_combined', 'price 3': 'price', 'price': 'msrp',\n            'price 2': 'savings', 'hit-link href': 'url', 'hit-link src': 'image_url',\n        }\n    },\n\n    # --- 2. MARKET INSIGHTS ---\n    'market_insights': {\n        'name': 'market_insights',\n        'primary_key': ['dealership_name', 'month', 'brand', 'model_name'],\n        'columns': [\n            {'name': 'dealership_name', 'type': 'string', 'required': True},\n            {'name': 'month', 'type': 'string', 'required': True},\n            {'name': 'brand', 'type': 'string', 'required': True},\n            {'name': 'model_name', 'type': 'string', 'required': True},\n            {'name': 'units_sold', 'type': 'int', 'required': True},\n            {'name': 'distance_miles', 'type': 'float', 'required': True},\n        ],\n        'column_map': {\n            'Dealership Name': 'dealership_name', 'Month': 'month', 'Brand': 'brand',\n            'Model Name': 'model_name', 'Units Sold': 'units_sold', 'Distance from Reference': 'distance_miles'\n        }\n    },\n\n    # --- 3. GEO SALES ---\n    'geo_sales': {\n        'name': 'geo_sales',\n        'primary_key': ['zip', 'radius_band'],\n        'columns': [\n            {'name': 'zip', 'type': 'string', 'required': True},\n            {'name': 'radius_band', 'type': 'string', 'required': True},\n            {'name': 'distance_mi', 'type': 'float', 'required': True},\n            {'name': 'your_zip_sales', 'type': 'int', 'required': True},\n            {'name': 'total_zip_sales', 'type': 'int', 'required': True},\n            {'name': 'zip_share', 'type': 'float', 'required': False},\n        ],\n        'column_map': {\n            'ZIP': 'zip', 'Name': 'radius_band', 'Distance (mi)': 'distance_mi',\n            'Your ZIP Sales': 'your_zip_sales', 'Total ZIP Sales': 'total_zip_sales',\n            'ZIP Share': 'zip_share',\n        }\n    },\n\n    # --- 4. SALES TOTAL ---\n    'sales_total': {\n        'name': 'sales_total',\n        'primary_key': ['brand', 'model', 'month'],\n        'columns': [\n            {'name': 'brand', 'type': 'string', 'required': True},\n            {'name': 'model', 'type': 'string', 'required': True},\n            {'name': 'month', 'type': 'string', 'required': True},\n            {'name': 'units_sold', 'type': 'int', 'required': True},\n        ],\n        'column_map': {\n            'Brand': 'brand', 'Model': 'model', 'Month': 'month', 'Units Sold': 'units_sold'\n        }\n    },\n\n    # --- 5. ADS DAILY ---\n    'ads_daily': {\n        'name': 'ads_daily',\n        'primary_key': ['date', 'campaign_id'],\n        'columns': [\n            {'name': 'date', 'type': 'date', 'required': True},\n            {'name': 'campaign_id', 'type': 'int', 'required': True},\n            {'name': 'impressions', 'type': 'int', 'required': True},\n            {'name': 'clicks', 'type': 'int', 'required': True},\n            {'name': 'cost', 'type': 'float', 'required': True},\n        ],\n        'column_map': {\n            'Date': 'date', 'Campaign_ID': 'campaign_id', 'Impressions': 'impressions',\n            'Clicks': 'clicks', 'Cost': 'cost',\n        }\n    },\n\n    # --- 6. CAMPAIGN SUMMARY ---\n    'campaign_summary': {\n        'name': 'campaign_summary',\n        'columns': [\n            {'name': 'campaign', 'type': 'string', 'required': True},\n            {'name': 'device', 'type': 'string', 'required': True},\n            {'name': 'network', 'type': 'string', 'required': True},\n            {'name': 'impressions', 'type': 'int', 'required': True},\n            {'name': 'clicks', 'type': 'int', 'required': True},\n            {'name': 'cost', 'type': 'float', 'required': True},\n        ],\n        'column_map': {\n            'Campaign': 'campaign', 'Device': 'device', 'Network (with search partners)': 'network',\n            'Impr.': 'impressions', 'Clicks': 'clicks', 'Cost': 'cost',\n        }\n    },\n\n    # --- 7. GOOGLE SEARCH TERMS ---\n    'google_search_terms': {\n        'name': 'google_search_terms',\n        'skip_header_rows': 2,\n        'columns': [\n            {'name': 'search_term', 'type': 'string', 'required': True},\n            {'name': 'match_type', 'type': 'string', 'required': False},\n        ],\n        'column_map': {\n            'Search term': 'search_term', 'Added/Excluded': 'match_type'\n        }\n    },\n\n    # --- 8. SPYFU OVERVIEW ---\n    'spyfu_overview': {\n        'name': 'spyfu_overview',\n        'columns': [\n            {'name': 'term', 'type': 'string', 'required': True},\n            {'name': 'monthly_searches', 'type': 'int', 'required': False},\n            {'name': 'ranking_difficulty', 'type': 'int', 'required': False},\n        ],\n        'column_map': {\n            'Term': 'term', 'MonthlySearches': 'monthly_searches', 'RankingDifficulty': 'ranking_difficulty'\n        }\n    },\n\n    # --- 9. SPYFU BACKLINKS ---\n    'spyfu_backlinks': {\n        'name': 'spyfu_backlinks',\n        'columns': [\n            {'name': 'backlink', 'type': 'string', 'required': True},\n            {'name': 'domain', 'type': 'string', 'required': True},\n            {'name': 'domain_strength', 'type': 'int', 'required': False},\n        ],\n        'column_map': {\n            'Backlink': 'backlink', 'Backlink Domain': 'domain', 'Domain Strength': 'domain_strength',\n        }\n    },\n\n    # --- 10. SPYFU RANKING HISTORY ---\n    'spyfu_ranking_history': {\n        'name': 'spyfu_ranking_history',\n        'columns': [\n            {'name': 'keyword', 'type': 'string', 'required': True},\n            {'name': 'start_rank', 'type': 'int', 'required': False},\n            {'name': 'end_rank', 'type': 'int', 'required': False},\n            {'name': 'rank_change', 'type': 'int', 'required': False},\n            {'name': 'search_volume', 'type': 'int', 'required': False},\n            {'name': 'end_clicks', 'type': 'int', 'required': False},\n            {'name': 'clicks_change', 'type': 'int', 'required': False},\n        ],\n        'column_map': {\n            'Keyword': 'keyword', 'StartRank': 'start_rank', 'EndRank': 'end_rank',\n            'RankChange': 'rank_change', 'SearchVolume': 'search_volume',\n            'EndClicks': 'end_clicks', 'ClicksChange': 'clicks_change'\n        }\n    },\n\n    # --- 11. SPYFU SEO KEYWORDS ---\n    'spyfu_seo_keywords': {\n        'name': 'spyfu_seo_keywords',\n        'columns': [\n            {'name': 'keyword', 'type': 'string', 'required': True},\n            {'name': 'rank', 'type': 'int', 'required': False},\n            {'name': 'rank_change', 'type': 'int', 'required': False},\n            {'name': 'top_rank', 'type': 'int', 'required': False},\n            {'name': 'search_volume', 'type': 'int', 'required': False},\n            {'name': 'difficulty', 'type': 'int', 'required': False},\n            {'name': 'seo_clicks', 'type': 'int', 'required': False},\n            {'name': 'seo_clicks_change', 'type': 'int', 'required': False},\n            {'name': 'total_monthly_clicks', 'type': 'int', 'required': False},\n            {'name': 'percent_mobile', 'type': 'float', 'required': False},\n            {'name': 'percent_desktop', 'type': 'float', 'required': False},\n            {'name': 'percent_paid', 'type': 'float', 'required': False},\n            {'name': 'percent_organic', 'type': 'float', 'required': False},\n            {'name': 'url', 'type': 'string', 'required': False},\n            {'name': 'cpc', 'type': 'float', 'required': False},\n        ],\n        'column_map': {\n            'Keyword': 'keyword', 'Rank': 'top_rank', 'Your Rank': 'rank', 'Your Rank Change': 'rank_change',\n            'Search Volume': 'search_volume', 'Ranking Difficulty': 'difficulty',\n            'SEO Clicks': 'seo_clicks', 'SEO Clicks Change': 'seo_clicks_change',\n            'Total Monthly Clicks': 'total_monthly_clicks',\n            'Mobile Search Percent': 'percent_mobile', 'Desktop Search Percent': 'percent_desktop',\n            'Paid Clicks Percent': 'percent_paid', 'Organic Clicks Percent': 'percent_organic',\n            'Your URL': 'url', 'Broad Cost Per Click': 'cpc'\n        }\n    },\n\n    # --- 12. SPYFU SEO KOMBAT ---\n    'spyfu_seo_kombat': {\n        'name': 'spyfu_seo_kombat',\n        'columns': [\n            {'name': 'keyword', 'type': 'string', 'required': True},\n            {'name': 'search_volume', 'type': 'int', 'required': False},\n            {'name': 'total_clicks', 'type': 'int', 'required': False},\n            {'name': 'is_question', 'type': 'string', 'required': False},\n        ],\n        'column_map': {\n            'Keyword': 'keyword', 'Search Volume': 'search_volume',\n            'Total Monthly Clicks': 'total_clicks', 'Is Question?': 'is_question'\n        }\n    },\n\n    # --- 13. SPYFU COMPETITORS ---\n    'spyfu_competitors': {\n        'name': 'spyfu_competitors',\n        'primary_key': ['domain_name'],\n        'columns': [\n            {'name': 'domain_name', 'type': 'string', 'required': True},\n            {'name': 'overlap', 'type': 'float', 'required': False},\n            {'name': 'common_keywords', 'type': 'int', 'required': False},\n            {'name': 'monthly_clicks', 'type': 'int', 'required': False},\n            {'name': 'monthly_value', 'type': 'float', 'required': False},\n        ],\n        'column_map': {\n            'Domain Name': 'domain_name', 'Overlap': 'overlap',\n            'Common Keywords': 'common_keywords',\n            'Monthly Clicks': 'monthly_clicks', 'Monthly Value of Clicks': 'monthly_value'\n        }\n    },\n\n    # --- 14. SEO TOP PAGES ---\n    'seo_top_pages': {\n        'name': 'seo_top_pages',\n        'columns': [\n            {'name': 'title', 'type': 'string', 'required': False},\n            {'name': 'url', 'type': 'string', 'required': True},\n            {'name': 'keyword', 'type': 'string', 'required': False},\n            {'name': 'rank', 'type': 'int', 'required': False},\n            {'name': 'search_volume', 'type': 'int', 'required': False},\n            {'name': 'clicks', 'type': 'int', 'required': False},\n            {'name': 'keyword_count', 'type': 'int', 'required': False},\n        ],\n        'column_map': {\n            'title': 'title', 'url': 'url', 'keyword': 'keyword', 'rank': 'rank',\n            'search_volume': 'search_volume', 'clicks': 'clicks', 'keyword_count': 'keyword_count',\n            'Title': 'title', 'Url': 'url', 'Top KW': 'keyword', 'Top KW Position': 'rank',\n            'Top KW Search Volume': 'search_volume', 'Top KW Clicks': 'clicks', 'Est Monthly SEO Clicks': 'clicks',\n            'Keyword Count': 'keyword_count'\n        }\n    },\n\n    # --- 15. SERP HISTORY (FULLY ALIGNED WITH SUPABASE DDL) ---\n    'serp_history': {\n        'name': 'serp_history',\n        'primary_key': ['date', 'keyword'],\n        'columns': [\n            {'name': 'date', 'type': 'date', 'required': True},\n            {'name': 'keyword', 'type': 'string', 'required': True},\n            {'name': 'our_position', 'type': 'string', 'required': True},\n            {'name': 'top1_domain', 'type': 'string', 'required': False},\n            {'name': 'top2_domain', 'type': 'string', 'required': False},\n            {'name': 'top3_domain', 'type': 'string', 'required': False},\n            {'name': 'zero_click', 'type': 'string', 'required': False},\n            {'name': 'zero_click_owner', 'type': 'string', 'required': False},\n            {'name': 'notes', 'type': 'string', 'required': False},\n        ],\n        'column_map': {\n            # Core fields\n            'date': 'date', 'Date': 'date',\n            'keyword': 'keyword', 'Keyword': 'keyword', 'Search Term': 'keyword',\n            'our_position': 'our_position', 'Our Position': 'our_position',\n            'Position': 'our_position', 'our position': 'our_position', 'Rank': 'our_position',\n\n            # Competitor domains\n            'top1_domain': 'top1_domain', 'Top 1 Domain': 'top1_domain', 'top 1 domain': 'top1_domain',\n            'Top1': 'top1_domain', '#1': 'top1_domain', '#1 Domain': 'top1_domain',\n            'top2_domain': 'top2_domain', 'Top 2 Domain': 'top2_domain', 'top 2 domain': 'top2_domain',\n            'Top2': 'top2_domain', '#2': 'top2_domain',\n            'top3_domain': 'top3_domain', 'Top 3 Domain': 'top3_domain', 'top 3 domain': 'top3_domain',\n            'Top3': 'top3_domain', '#3': 'top3_domain',\n\n            # Zero-click fields\n            'zero_click': 'zero_click', 'Zero Click': 'zero_click', 'Featured Snippet': 'zero_click',\n            'zero click type': 'zero_click',\n            'zero_click_owner': 'zero_click_owner', 'Zero Click Owner': 'zero_click_owner',\n            'Snippet Owner': 'zero_click_owner', 'Claimed By': 'zero_click_owner',\n\n            # Notes\n            'notes': 'notes', 'Notes': 'notes', 'Note': 'notes',\n        }\n    },\n}\n\n# =============================================================================\n# SCHEMA DETECTION\n# =============================================================================\n\ndef detect_schema(df: pd.DataFrame, filename: str = '') -> str:\n    cols = [str(c).lower().strip() for c in df.columns]\n    fname = filename.lower()\n\n    # Filename overrides\n    if 'ranking_history' in fname: return 'spyfu_ranking_history'\n    if 'seo_keywords' in fname: return 'spyfu_seo_keywords'\n    if 'backlink' in fname: return 'spyfu_backlinks'\n    if 'competitor' in fname: return 'spyfu_competitors'\n    if 'kombat' in fname: return 'spyfu_seo_kombat'\n    if 'toppages' in fname or 'top_pages' in fname: return 'seo_top_pages'\n    if 'serp' in fname or 'serp_history' in fname: return 'serp_history'\n\n    # Content-based detection\n    if any(x in cols for x in ['vin', 'vin-row', 'vehicle identification number']): return 'inventory_vehicle'\n    if 'dealership name' in cols and 'units sold' in cols: return 'market_insights'\n    if 'campaign_id' in cols: return 'ads_daily'\n    if 'search term' in cols and ('added/excluded' in cols or 'match type' in cols): return 'google_search_terms'\n    if 'device' in cols and 'network' in cols: return 'campaign_summary'\n    if 'radius_band' in cols or ('zip' in cols and 'distance (mi)' in cols): return 'geo_sales'\n    if 'term' in cols and 'monthlysearches' in cols: return 'spyfu_overview'\n\n    # SERP History specific\n    if ('date' in cols and 'keyword' in cols and 'our_position' in cols and\n        any(t in cols for t in ['top1_domain', 'top 1 domain', 'top1', '#1'])):\n        return 'serp_history'\n\n    return 'unknown'\n\n# =============================================================================\n# DERIVED METRICS & LINEAGE\n# =============================================================================\n\ndef add_derived_metrics(df: pd.DataFrame, schema_name: str) -> pd.DataFrame:\n    df = df.copy()\n\n    if schema_name == 'inventory_vehicle':\n        combined_cols = [c for c in df.columns if 'make_model_combined' in str(c).lower()]\n        if combined_cols:\n            combined_col = combined_cols[0]\n            def parse_vehicle(val):\n                if is_null(val): return None, None, None\n                val = str(val).strip()\n                year_match = re.search(r'\\b(20\\d{2})\\b', val)\n                year = int(year_match.group(1)) if year_match else None\n                val = re.sub(r'\\b20\\d{2}\\b', '', val).strip()\n                val = re.sub(r'^(New|Used|Certified|CPO)\\s+', '', val, flags=re.IGNORECASE).strip()\n                parts = val.split(' ', 1)\n                make = parts[0] if parts else None\n                model = parts[1] if len(parts) > 1 else None\n                return year, make, model\n\n            if 'year' not in df.columns or df['year'].isnull().all():\n                parsed = df[combined_col].apply(parse_vehicle)\n                df['year'] = parsed.apply(lambda x: x[0])\n                df['make'] = parsed.apply(lambda x: x[1])\n                df['model'] = parsed.apply(lambda x: x[2])\n\n        if 'image_url' in df.columns:\n            df['image_url'] = df['image_url'].astype(str).apply(\n                lambda x: x.split(',')[0].strip().strip('\"') if ',' in x else x\n            )\n\n    return df\n\ndef add_lineage(df: pd.DataFrame, source_file: str) -> pd.DataFrame:\n    df = df.copy()\n    df['_source_file'] = source_file\n    df['_ingested_at'] = datetime.utcnow().isoformat()\n    return df\n\n# =============================================================================\n# MAIN NORMALIZATION FUNCTION\n# =============================================================================\n\ndef normalize_csv(df: pd.DataFrame, schema: Dict[str, Any], source_file: str, add_derived: bool = True) -> pd.DataFrame:\n    df = df.copy()\n\n    # Skip header rows if specified\n    skip_rows = schema.get('skip_header_rows', 0)\n    if skip_rows > 0:\n        df = df.iloc[skip_rows:].reset_index(drop=True)\n    elif len(df) > 0 and len(df.columns) > 0:\n        first_cell = str(df.iloc[0, 0])\n        if \"report\" in first_cell.lower() or \"generated\" in first_cell.lower():\n            df = df.iloc[2:].reset_index(drop=True)\n\n    # Column renaming\n    column_map = schema.get('column_map', {})\n    df_cols_lower = {c.lower().strip(): c for c in df.columns}\n    actual_map = {df_cols_lower.get(k.lower().strip()): v for k, v in column_map.items() if k.lower().strip() in df_cols_lower}\n    df = df.rename(columns=actual_map)\n\n    # Type conversion\n    for col_def in schema['columns']:\n        col_name = col_def['name']\n        if col_name not in df.columns:\n            continue\n        series = df[col_name]\n        if isinstance(series, pd.DataFrame):\n            series = series.iloc[:, -1]\n\n        if col_def['type'] == 'int':\n            df[col_name] = series.apply(normalize_int)\n        elif col_def['type'] == 'float':\n            df[col_name] = series.apply(normalize_float)\n        elif col_def['type'] == 'date':\n            df[col_name] = series.apply(normalize_date)\n        elif col_def['type'] == 'string':\n            if col_name in ['zip', 'zip_code']:\n                df[col_name] = series.apply(normalize_zip)\n            else:\n                df[col_name] = series.apply(normalize_string)\n\n    # Add lineage and derived metrics\n    df = add_lineage(df, source_file)\n    if add_derived:\n        df = add_derived_metrics(df, schema['name'])\n\n    # Strict column filtering\n    schema_cols = [c['name'] for c in schema['columns']]\n    system_cols = [c for c in df.columns if str(c).startswith('_')]\n    keep_cols = list(dict.fromkeys(schema_cols + system_cols))\n\n    return df[[c for c in keep_cols if c in df.columns]]